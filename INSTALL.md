# Installation

We suggest users to try out the debloating tools and run tests in an isolated docker container so as to avoid contaminating the host system (because fuzzing is used). As a prerequisite, you need to have the Docker engine installed in your system. If you haven't done so, please refer to [Docker's installation page](https://docs.docker.com/engine/install/) and make sure the Docker engine is properly installed. Once you have done that, you may begin with the installation and the setup of the debloating tools and the testing environment.

First make sure you are in the root directory of this repo (`debloating_study`), and then follow the steps below.

1. `cd docker`
2. `docker build -t debstudy:1.0 .`
3. `docker run -it debstudy:1.0 /bin/bash`

**Note**: Step 2 can take **~10 minutes** to finish. Do not leave out the ending DOT when running it.

After this, you will get into a container in which you're initially located in the root directory. 

Run the shell commands below to download the debloating study repo (within the container), get into it, and complete the setup of debloating tools and testing environment.
```
git clone https://github.com/qixin5/debloating_study.git
cd debloating_study
./setup.sh
```


### Quick Example

Here is a quick example to test whether the installation is OK.

To run it, first make sure you are in `debloating_study`, and then do the following:
```
cd expt/script/examples/toy
./run_cov.sh
```

After this, you should see a file `toy.reduced.c` whose content is the same as what's shown below.
```
int main(int argc , char **argv)
{
  int x = atoi(*(argv + 1));
  if (x >= 0) {
    printf("x >= 0\n");
  }
  else {

  }
}
```

#### Troubleshooting

If you see an error message like *"/debloating_study/tools/debaug/bin/startandendlineprinter: line 8:  546 Illegal instruction (core dump) $PRINTERBIN -g statement test.sh ${srcf}"*, please follow the steps below for a complete build of the tools and try again.
```
cd ${DEBSTUDY_DIR}/tools/debaug
./setup_full.sh
```
**Note**: Running `./setup_full.sh` builds LLVM from source code and takes a few hours!


### Another Example

In this example, you will run a total of six tools to debloat `tcas` (a program in the SIR benchmark) and evaluate the debloated programs in terms of reduction, generality, and their tradeoff. 

To run the example, first make sure you are in `debloating_study`, and then do the following:

```
cd expt/script
examples/tcas/run_tcas.sh
```

Once it's done, you should be able to see something similar to what's shown in [expt/script/examples/tcas/rslt.txt](expt/script/examples/tcas/rslt.txt) displayed in your screen.

You may also check the debloated programs generated by the tools. They are located at *expt/debaug/benchmark/tcas/src/reduced* (for programs made by tools other than Razor) and *expt/debaug/benchmark/tcas/razor_code/reduced* (for programs made by Razor). Note that the debloated programs made by CovA and CovF are located in folders named n10train_covfaug* and n10train_covrds*. 

**Notes**
1. Running `run_tcas.sh` takes **~30 minutes**.
2. Because of randomness involved in debloating and fuzz testing, you probably won't get the exact same result we provided in `rslt.txt`. Overall, however, your result should be reasonably similar to ours. Note that Debop could be an exception. Because it only runs for less than half a minute, its results could vary a lot in different runs.

### Reproduction

We provide test scripts to run our experiments to obtain debloated programs and evaluate them. 

To run the experiment, first make sure you are in the directory of `debloating_study`, then run `cd expt/script` to get into the script directory. Next, you can use either `utilprog/main/run.sh` to debloat a utility program or `sirprog/main/run.sh` to debloat a SIR program.

To debloat a utility program, you should run
```
utilprog/main/run.sh PROGNAME TOOL [THRESHOLD]
```
where PROGNAME is the name of the program to be debloated (one of *bzip2-1.0.5*, *chown-8.2*, *date-8.21*, *grep-2.19*, *gzip-1.2.4*, *mkdir-5.2.1*, *rm-8.4*, *sort-8.16*, *tar-1.14*, and *uniq-8.16*), TOOL is the name of the debloating tool (one of *chisel*, *debop*, *cov*, *covf*, *cova*, and *razor*), and THRESHOLD is the augmentation threshold for cova (from 1 to 100) and razor (from 1 to 4). Note that you do not need to provide THRESHOLD for tools other than cova and razor.

To debloat a SIR program, you should run
```
sirprog/main/run.sh PROGNAME INPUTSET TESTSET TOOL [THRESHOLD]
```
where PROGNAME is the name of the program to be debloated (one of *flex-2.5.4*, *grep-2.4.2*, *gzip-1.3*, *make-3.79*, *sed-4.1.5*, *space*, *bash-2.05*, *vim-5.8*, *printtokens2*, *printtokens*, *replace*, *schedule2*, *schedule*, *tcas*, and *totinfo*), TOOL is the name of the debloating tool (again, one of *chisel*, *debop*, *cov*, *covf*, *cova*, and *razor*), INPUTSET is the set of inputs based on which debloating is performed (one of *n10train*, *p0.1train*, *p0.2train*, and *p0.3train*), TESTSET is the set of inputs used to evaluate the debloated program (one of *n10test*, *p0.1test*, *p0.2test*, and *p0.3test*), and finally, again, THRESHOLD is the augmentation threshold for cova (from 1 to 100) and razor (from 1 to 4).

For utility programs, you don't need to specify INPUTSET and TESTSET because debloating will be performed based on each of the ten sets of inputs we collected and the debloated program will be evaluated based on each set of testing inputs not used for debloating.

Once done, if successful, you will see scores in the same format as what's shown in [expt/script/examples/tcas/rslt.txt](expt/script/examples/tcas/rslt.txt). You can check these against our result provided in [here](https://docs.google.com/spreadsheets/d/1uH8fzJLFjUsFHEur-fze1D0RmG22QWG_1RTAaWlAJXI/edit?usp=sharing). It is based on this result the scores in the paper was computed. For example, if you run `utilprog/main/run.sh uniq-8.16 cov`, you can check against Rows 12 and 28 in the Cov table.

**Note**
1. Running `sirprog/main/run.sh` usually takes more than 30 minutes. And running `utilprog/main/run.sh` can be (much) longer because debloating and its evaluation are performed based on multiple sets of inputs.
2. If you use chisel or debop, which are expensive, the experiment can take more than 6 hours to finish.
3. As previously explained, because of randomness involved in debloating and fuzzing, you probably won't see the exact same scores we provided, although they are expected to be reasonably similar.
